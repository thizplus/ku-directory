# ทำไมต้องเปลี่ยนเป็น Server-Centric Sync?

## คำถามของคุณ
> "ก่อนที่จะเปลี่ยนมาเป็นระบบนี้ ผมว่าทุกอย่างมันใช้งานได้ดีแล้วนะครับ แต่แค่เปลี่ยนเป็น centric sync ถึงแก้ไขโครงสร้างหมดเลยหรอ?"

## คำตอบสั้นๆ

**ไม่จำเป็นต้องแก้ทั้งหมด** ถ้าคุณใช้งานคนเดียว ระบบเดิม (User-Centric) ก็ใช้ได้ดี

แต่ถ้าคุณต้องการให้ **หลายคนใช้ folder เดียวกันร่วมกัน** โดยไม่ต้อง sync ซ้ำ → ต้องเปลี่ยนโครงสร้าง

---

## เปรียบเทียบ 2 ระบบ

### ระบบเดิม: User-Centric (User เป็นเจ้าของ)

```
┌─────────────────────────────────────────────────────────┐
│  Google Drive Folder: "กิจกรรม กอ."                      │
│  (มีรูป 1,000 รูป)                                       │
└─────────────────────────────────────────────────────────┘
                    │
        ┌───────────┴───────────┐
        ▼                       ▼
┌───────────────┐       ┌───────────────┐
│   User A      │       │   User B      │
│   Sync →      │       │   Sync →      │
│   1,000 รูป   │       │   1,000 รูป   │
│   (ของ A)     │       │   (ของ B)     │
└───────────────┘       └───────────────┘
        │                       │
        ▼                       ▼
┌───────────────┐       ┌───────────────┐
│  photos table │       │  photos table │
│  user_id = A  │       │  user_id = B  │
│  1,000 rows   │       │  1,000 rows   │
└───────────────┘       └───────────────┘

รวม: 2,000 rows ใน database (ซ้ำกัน!)
```

**ปัญหา:**
1. **ข้อมูลซ้ำ** - 2 คน = 2,000 rows, 10 คน = 10,000 rows (รูปเดิมๆ ทั้งนั้น)
2. **Sync ซ้ำ** - ทุกคนต้อง sync เอง (เปลือง bandwidth, เวลา)
3. **Webhook ใช้ไม่ได้** - Drive แจ้งมาที ไม่รู้จะ update ให้ใคร
4. **Real-time ไม่ work** - A upload รูปใหม่ → B ไม่รู้จนกว่าจะ sync เอง

---

### ระบบใหม่: Server-Centric (Server เป็นเจ้าของ)

```
┌─────────────────────────────────────────────────────────┐
│  Google Drive Folder: "กิจกรรม กอ."                      │
│  (มีรูป 1,000 รูป)                                       │
└─────────────────────────────────────────────────────────┘
                    │
                    ▼
         ┌──────────────────┐
         │  Server Sync     │
         │  (ครั้งเดียว)    │
         └──────────────────┘
                    │
                    ▼
         ┌──────────────────┐
         │  shared_folders  │  ← 1 row
         │  photos table    │  ← 1,000 rows (ไม่มี user_id)
         └──────────────────┘
                    │
        ┌───────────┴───────────┐
        ▼                       ▼
┌───────────────┐       ┌───────────────┐
│   User A      │       │   User B      │
│   (มีสิทธิ์)   │       │   (มีสิทธิ์)   │
│   ดูได้       │       │   ดูได้       │
└───────────────┘       └───────────────┘

รวม: 1,000 rows เท่าเดิม (ไม่ซ้ำ!)
```

**ข้อดี:**
1. **ไม่มีข้อมูลซ้ำ** - 2 คน, 10 คน, 100 คน = 1,000 rows เท่าเดิม
2. **Sync ครั้งเดียว** - Server sync แล้ว share ให้ทุกคน
3. **Webhook work** - Drive แจ้ง → Server sync → ทุกคนเห็น
4. **Real-time work** - A upload → Server sync → B เห็นทันที

---

## ทำไมต้องแก้โครงสร้าง?

### ปัญหาหลัก: `photos.user_id`

**ระบบเดิม:**
```sql
-- ทุก query ต้องมี user_id
SELECT * FROM photos WHERE user_id = 'xxx' AND ...
```

**ระบบใหม่:**
```sql
-- query ด้วย shared_folder_id แทน
SELECT * FROM photos WHERE shared_folder_id = 'xxx' AND ...
```

ถ้าจะเปลี่ยนจาก `user_id` เป็น `shared_folder_id` ต้องแก้:

| ส่วนที่ต้องแก้ | เหตุผล |
|---------------|--------|
| **Database Schema** | เพิ่ม `shared_folders`, `user_folder_access` tables |
| **Photo Repository** | เปลี่ยน query จาก `user_id` เป็น `shared_folder_id` |
| **Sync Worker** | Sync ต่อ folder แทน sync ต่อ user |
| **API Handlers** | Return photos ตาม folder ที่ user มีสิทธิ์ |
| **WebSocket** | Broadcast ไปยัง "ห้อง" (folder) แทน broadcast ไปยัง user |

---

## ถ้าไม่อยากแก้โครงสร้าง มีทางอื่นไหม?

### ทางเลือก 1: ใช้ระบบเดิม (User-Centric)

**เหมาะกับ:**
- ใช้งานคนเดียว
- แต่ละคนมี folder ของตัวเอง (ไม่ share)
- ไม่ต้องการ real-time sync

**ข้อเสีย:**
- ข้อมูลซ้ำถ้าหลายคนใช้ folder เดียวกัน
- ต้อง sync เอง

### ทางเลือก 2: Hybrid (แก้บางส่วน)

**วิธี:**
- เก็บ `user_id` ไว้ แต่เพิ่ม `shared_folder_id`
- ค่อยๆ migrate ทีละส่วน

**ข้อเสีย:**
- Code ซับซ้อน (บางที่ใช้ user_id, บางที่ใช้ shared_folder_id)
- Bug ง่าย

### ทางเลือก 3: Full Refactor (ที่เราทำ)

**วิธี:**
- ลบ `user_id` ออกจาก photos
- ใช้ `shared_folder_id` เป็น key หลัก
- เพิ่ม `user_folder_access` เก็บว่าใครเข้าถึง folder ไหนได้

**ข้อดี:**
- Code clean
- ไม่มีข้อมูลซ้ำ
- Real-time work ได้

---

## สรุป

| คำถาม | คำตอบ |
|-------|-------|
| ระบบเดิมใช้ได้ไหม? | ใช้ได้ ถ้าใช้คนเดียว |
| ทำไมต้องเปลี่ยน? | เพื่อให้หลายคน share folder เดียวกันได้ โดยไม่ซ้ำ |
| ต้องแก้หมดเลยหรอ? | ส่วนใหญ่ต้องแก้ เพราะ `user_id` → `shared_folder_id` |
| มีทางลัดไหม? | มี แต่ code จะซับซ้อน + bug ง่าย |

---

## Diagram สรุป

```
┌────────────────────────────────────────────────────────────────┐
│                     USER-CENTRIC (เดิม)                        │
├────────────────────────────────────────────────────────────────┤
│  User A → sync → photos (user_id=A)                           │
│  User B → sync → photos (user_id=B)  ← ซ้ำกัน!                │
│                                                                │
│  ✗ ข้อมูลซ้ำ                                                   │
│  ✗ Sync หลายครั้ง                                              │
│  ✗ Webhook/Real-time ยาก                                       │
└────────────────────────────────────────────────────────────────┘

                            ▼ เปลี่ยนเป็น

┌────────────────────────────────────────────────────────────────┐
│                    SERVER-CENTRIC (ใหม่)                        │
├────────────────────────────────────────────────────────────────┤
│  Server → sync → photos (shared_folder_id=X)                  │
│                                                                │
│  User A ───┐                                                   │
│            ├─→ user_folder_access → ดู photos ของ folder X    │
│  User B ───┘                                                   │
│                                                                │
│  ✓ ไม่มีข้อมูลซ้ำ                                               │
│  ✓ Sync ครั้งเดียว                                              │
│  ✓ Webhook/Real-time work                                      │
└────────────────────────────────────────────────────────────────┘
```

---

## คำถามที่อาจมี

### Q: ถ้าผมใช้คนเดียว ต้องเปลี่ยนไหม?
**A:** ไม่จำเป็น ระบบเดิมก็ใช้ได้ดี

### Q: ทำไมไม่ทำ Hybrid?
**A:** ทำได้ แต่ code จะซับซ้อนขึ้น และ maintain ยาก

### Q: เสียเวลาไหม?
**A:** ใช่ แต่ในระยะยาวจะคุ้ม ถ้าต้องการ scale หรือให้หลายคนใช้

### Q: ถ้าอยากกลับไปใช้ระบบเดิม?
**A:** ได้ครับ แค่ rollback database migration และ code
